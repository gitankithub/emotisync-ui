<div class="chat-wrapper">
  <div class="chat-header">
    <div class="header-details">
      <h2>{{ reservation?.hotelName }}</h2>
      <p>
        Check-in: {{ reservation?.checkIn | date:'mediumDate' }} |
        Check-out: {{ reservation?.checkOut | date:'mediumDate' }}
      </p>
      <p>Room: {{ reservation?.roomType }} | Guests: {{ reservation?.guests }}</p>
      <p *ngIf="activeRequest">
        Request: {{ activeRequest.requestId }} â€” {{ activeRequest.requestType }} |
        Status: {{ activeRequest.status | titlecase }}
      </p>
    </div>

   <div class="new-request">
    <button class="new-request-btn" (click)="startNewRequest()">+ New Request</button>
  </div>
  </div>

  <div class="chat-body" #popupScroll>
    <!-- Always show options â€” but submit only if there's no active request -->
    <h3>How can we help you today?</h3>

    <div class="options">
      <button *ngFor="let opt of options"
              [class.selected]="selectedOption === opt"
              (click)="selectOption(opt)"
              class="option-btn">
        {{ opt }}
      </button>
    </div>

    <!-- Other box -->
    <div *ngIf="selectedOption === 'Others'" class="other-box">
      <textarea [(ngModel)]="otherIssue" placeholder="Describe your issue..."></textarea>
    </div>

    <!-- Submit button visible only when no activeRequest exists -->
    <div *ngIf="!activeRequest" class="submit-section">
      <button mat-flat-button color="primary" (click)="submitIssue()" [disabled]="!selectedOption && !otherIssue">Submit</button>
    </div>

    <!-- Bot messages (for active requests) -->
    <div *ngIf="activeRequest" class="bot-section">
      <div *ngFor="let m of chatMessages" [class.user]="m.sender === 'user'" [class.bot]="m.sender === 'bot'">
        <div class="msg-bubble">{{ m.text }}</div>
      </div>

      <div *ngIf="isTyping" class="typing-indicator"><span></span><span></span><span></span></div>

      <!-- Feedback at the end -->
      <div *ngIf="stage === 'final'" class="final-section">
        <p>How would you rate this service?</p>
        <div class="emoji-bar">
          <button *ngFor="let r of [1,2,3,4,5]" (click)="selectFinalRating(r)">
            {{ ['ğŸ˜','ğŸ˜','ğŸ™‚','ğŸ˜ƒ','ğŸ¤©'][r-1] }}
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Floating chat popup (small chat inside) -->
  <!-- Floating Chat Button -->
<button mat-fab color="primary" class="chat-bot-btn" (click)="openMiniChat()">
  <mat-icon>chat</mat-icon>
</button>

<!-- CTA Assistance Sliding Chat -->
<app-chat
  *ngIf="isChatVisible"
  class="slide-in-chat"
  (closeChat)="closeMiniChat()"
></app-chat>



</div>
